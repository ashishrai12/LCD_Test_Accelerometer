name: AVR Build CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install AVR Toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-avr avr-libc

    - name: Build Project
      run: |
        # Compile drivers
        avr-gcc -mmcu=atmega32 -DF_CPU=16000000UL -Os -c drivers/lcd.c -o drivers/lcd.o
        avr-gcc -mmcu=atmega32 -DF_CPU=16000000UL -Os -c drivers/accel.c -o drivers/accel.o
        
        # Compile main and link
        avr-gcc -mmcu=atmega32 -DF_CPU=16000000UL -Os src/main.c drivers/lcd.o drivers/accel.o -o main.elf
        
        # Verify hex generation
        avr-objcopy -j .text -j .data -O ihex main.elf main.hex

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: main-hex
        path: main.hex

